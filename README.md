# Hetzner Server Terraform Infrastructure

Infrastructure as Code (IaC) for automated deployment of a cloud architecture on Hetzner Cloud with bastion host, isolated private network, and application servers.

## 📋 Table of Contents

- [Architecture](#-architecture)
- [Components](#-components)
- [Prerequisites](#-prerequisites)
- [Configuration](#-configuration)
- [Deployment](#-deployment)
- [Connecting to Servers](#-connecting-to-servers)
- [Project Structure](#-project-structure)
- [Maintenance](#-maintenance)
- [Contributing](#-contributing)

## 🏗 Architecture

```
                              Internet
                                 |
                                 |
                    ┌────────────▼───────────┐
                    │   Bastion Host         │
                    │   (NAT + DNS)          │
                    │   Public IP: X.X.X.X   │
                    │   Private IP: 10.0.0.2 │
                    └────────────┬───────────┘
                                 |
                    ┌────────────▼───────────────┐
                    │   Private Network          │
                    │   10.0.0.0/16              │
                    │   (Hetzner Cloud Network)  │
                    └────────────┬───────────────┘
                                 |
              ┌──────────────────┼──────────────────┐
              │                  │                  │
     ┌────────▼────────┐ ┌──────▼──────┐  ┌───────▼────────┐
     │  Database       │ │  PHP-Nginx  │  │  Other VMs     │
     │  10.0.0.4       │ │  10.0.0.X   │  │  10.0.0.X      │
     │  NO Public IP   │ │  NO Public  │  │  NO Public IP  │
     └─────────────────┘ └─────────────┘  └────────────────┘
```

### Key Features:

- **Complete Isolation**: Private servers have no public IP and are not directly reachable from the Internet
- **Bastion Host**: Single SSH access point with public IP, acts as NAT gateway and DNS server
- **Internal DNS**: dnsmasq on bastion for internal domain resolution (*.internal)
- **NAT Gateway**: All internet traffic from private servers routes through the bastion
- **Internal SSH Keys**: Automatically generated by Terraform for bastion ↔ private servers communication
- **Monitoring**: Netdata installed on all servers with basic auth authentication

## 🧩 Components

### 1. Bastion Host
- **Role**: NAT Gateway, DNS server (dnsmasq), SSH jump host
- **Networking**: Public IP + Private IP (10.0.0.0/16)
- **Features**:
  - IP forwarding and NAT with iptables
  - dnsmasq for internal DNS
  - Internal SSH key for private server access

### 2. Database Server
- **Role**: Containerized MariaDB with Docker
- **Networking**: Private IP only (no direct internet)
- **Features**:
  - MariaDB in Docker with data persistence
  - Netdata for monitoring
  - Nginx as reverse proxy for Netdata
  - Read-only user for monitoring

### 3. PHP-Nginx Server (Module)
- **Role**: Application server
- **Networking**: Private IP only
- **Features**: Web server with PHP-FPM and Nginx

### 4. Networking
- **Private Network**: 10.0.0.0/16 (Hetzner Cloud Network)
- **Route**: Traffic 0.0.0.0/0 → Bastion (NAT gateway)
- **DNS**: Private servers use bastion (10.0.0.2/10.0.0.3) as nameserver

## 📦 Prerequisites

- [Terraform](https://www.terraform.io/downloads) >= 1.0
- [Hetzner Cloud](https://www.hetzner.com/cloud) account
- SSH key added to Hetzner Cloud project
- Local private SSH key for connection (default: `~/.ssh/id_rsa`)

## ⚙️ Configuration

### 1. Create `terraform.tfvars` file

Copy the template and fill in your values:

```bash
cp terraform.tfvars.template terraform.tfvars
```

Edit `terraform.tfvars` with your values:

```hcl
hcloud_token              = "YOUR_HETZNER_API_TOKEN"
server_type               = "cx22"
bastion_host_server_name  = "bastion-host"
bastion_host_server_type  = "cx11"
location                  = "nbg1"

# Passwords
netdata_password              = "YOUR_STRONG_PASSWORD"
mariadb_root_password         = "YOUR_STRONG_PASSWORD"
mariadb_password              = "YOUR_STRONG_PASSWORD"
mariadb_readonly_password     = "YOUR_STRONG_PASSWORD"

# SSH Key (optional, default: ~/.ssh/id_rsa)
ssh_bastion_private_key_path = "~/.ssh/id_rsa"
```

### 2. Main Variables

| Variable | Description | Default         |
|----------|-------------|-----------------|
| `hcloud_token` | Hetzner Cloud API token | -               |
| `server_type` | Server type for private VMs | `cx22`          |
| `bastion_host_server_type` | Bastion server type | `cx11`          |
| `location` | Hetzner location | `nbg1`          |
| `network_name` | Private network name | `armah-network` |
| `ssh_key_name` | SSH key name in Hetzner | `key-pub`       |
| `ssh_bastion_private_key_path` | Private SSH key path | `~/.ssh/id_rsa` |

## 🚀 Deployment

### 1. Initialize Terraform

```bash
terraform init
```

### 2. Review the deployment plan

```bash
terraform plan
```

### 3. Apply the configuration

```bash
terraform apply --auto-approve
```

Deployment takes **5-10 minutes**. Terraform will:
1. Create the private network and subnet
2. Generate internal SSH keys (RSA 4096-bit)
3. Create the bastion host and wait for cloud-init completion
4. Configure the route for internet via bastion
5. Create private servers (database, php-nginx)

### 4. Get server IPs

```bash
# Bastion public IP
terraform output | grep bastion

# Private IPs
terraform state show hcloud_server.bastion | grep network
terraform state show 'module.database.hcloud_server.database_cluster_vm' | grep network
```

## 🔐 Connecting to Servers

### Bastion Host (direct access)

```bash
ssh root@<bastion_public_ip>
```

### Private Servers (via bastion jump host)

```bash
# Database server
ssh -J root@<bastion_public_ip> root@<database_private_ip>

# PHP-Nginx server
ssh -J root@<bastion_public_ip> root@<php_nginx_private_ip>
```

### Direct connection from bastion to private servers

```bash
# From bastion
ssh -i /root/.ssh/id_rsa_internal root@<database_private_ip>
```

## 📁 Project Structure

```
.
├── main.tf                      # Main configuration
├── variables.tf                 # Variable definitions
├── networks.tf                  # Private network and route configuration
├── provider.tf                  # Terraform providers (hcloud, tls, null)
├── terraform.tfvars.template    # Variables template
├── .gitignore                   # Files to exclude from Git
├── templates/
│   └── userdata_bastion.tpl     # Bastion cloud-init script
└── modules/
    ├── database/
    │   ├── main.tf              # Database server
    │   ├── variables.tf
    │   ├── outputs.tf
    │   └── templates/
    │       ├── userdata_database.tpl       # Database cloud-init
    │       └── nginx_netdata.conf.tpl      # Netdata Nginx config
    └── php-nginx/
        ├── main.tf              # PHP-Nginx server
        ├── variables.tf
        └── templates/
            └── userdata_php_nginx.tpl
```

## 🛠 Maintenance

### View state

```bash
terraform show
```

### Destroy infrastructure

```bash
terraform destroy
```

### Refresh state

```bash
terraform refresh
```

### Debug connectivity

**On bastion:**
```bash
# Verify NAT
iptables -t nat -L -n -v
cat /proc/sys/net/ipv4/ip_forward

# Verify dnsmasq
systemctl status dnsmasq
netstat -tulpn | grep :53
```

**On database server:**
```bash
# Test internet connectivity
ping -c 3 8.8.8.8

# Test DNS
nslookup google.com

# Verify routes
ip route show
```

## 🤝 Contributing

Contributions, issues, and feature requests are welcome!

### How to contribute

1. **Fork the project**
   ```bash
   git clone https://github.com/francesco-oghabi/hetzner-server-terraform.git
   cd hetzner-server-terraform
   ```

2. **Create a feature branch**
   ```bash
   git checkout -b feature/feature-name
   ```

3. **Commit your changes**
   ```bash
   git add .
   git commit -m "feat: Feature description"
   ```

4. **Push the branch**
   ```bash
   git push origin feature/feature-name
   ```

5. **Open a Pull Request**

### Guidelines

- **Code**: Follow Terraform best practices (use `terraform fmt` to format)
- **Sensitive variables**: NEVER commit `.tfvars`, `.tfstate` files or credentials
- **Documentation**: Update README for new features
- **Testing**: Test changes with `terraform plan` before committing
- **Commit messages**: Use [Conventional Commits](https://www.conventionalcommits.org/)
  - `feat:` for new features
  - `fix:` for bug fixes
  - `docs:` for documentation changes
  - `refactor:` for refactoring

### Reporting bugs

Open an [issue](https://github.com/YOUR_USERNAME/hetzner-server-terraform/issues) including:
- Problem description
- Terraform version (`terraform version`)
- Output of `terraform plan` or `terraform apply` command (remove sensitive data)
- Relevant logs

### Proposing features

Open an [issue](https://github.com/YOUR_USERNAME/hetzner-server-terraform/issues) with the `enhancement` tag describing:
- The proposed feature
- Use case
- Any alternatives considered

## 📝 License

This project is distributed under the MIT License. See the `LICENSE` file for more details.

## 🙏 Acknowledgments

- [Hetzner Cloud](https://www.hetzner.com/cloud) for the infrastructure
- [Terraform](https://www.terraform.io/) for IaC
- [Netdata](https://www.netdata.cloud/) for monitoring

---

**Note**: This project is provided "as-is" without warranties. Use at your own risk. Make sure you understand the costs associated with Hetzner Cloud infrastructure before deploying.